<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Strategist Pro - Herramienta Profesional de Marketing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        /* Header mejorado */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        
        .nav-menu a:hover {
            opacity: 1;
        }
        
        /* Container principal */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        /* Tabs de navegación */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e1e1;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        /* Cards mejoradas */
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        /* Grid de formulario */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }
        
        .label-helper {
            font-size: 14px;
            color: #666;
            font-weight: normal;
            margin-left: 5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Sección de análisis avanzado */
        .advanced-options {
            background: #f8f9fa;
            border: 2px dashed #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .toggle-advanced {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Botones mejorados */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f1f3f5;
            color: #495057;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Resultados mejorados */
        .results-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .strategy-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .metrics-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
        }
        
        .metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Loading mejorado */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }
        
        /* Tags de estrategia */
        .strategy-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .tag {
            background: #e7f5ff;
            color: #1971c2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        /* Historial mejorado */
        .history-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Estilo para plantillas seleccionadas */
        .template-selected {
            border-color: #667eea !important;
            background: #f0f4ff !important;
        }

        /* NUEVA SECCIÓN: Contenedor de todos los resultados */
        .all-results-container {
            margin-top: 40px;
        }

        /* Separador visual entre resultados */
        .results-separator {
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            margin: 40px 0;
        }

        /* Indicador de tipo de análisis */
        .analysis-type-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .badge-basic {
            background: #e7f5ff;
            color: #1971c2;
        }

        .badge-competitive {
            background: #ffe0e0;
            color: #c92a2a;
        }

        /* Tabs para cambiar entre resultados existentes */
        .results-tabs {
            display: none;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e1e1;
        }

        .results-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
        }

        .results-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Animación al agregar nuevos resultados */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-result {
            animation: fadeInUp 0.5s ease;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                🚀 Affiliate Strategist Pro
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a href="#generator">Generador</a></li>
                    <li><a href="#templates">Plantillas</a></li>
                    <li><a href="#analytics">Analytics</a></li>
                    <li><a href="#history">Historial</a></li>
                </ul>
            </nav>
        </div>
    </header>
    {% if user.is_authenticated %}
<div style="background: #f8f9fa; padding: 15px 0; border-bottom: 1px solid #dee2e6;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <span style="font-size: 24px;">👤</span>
            <div>
                <strong>Hola, {{ user.username }}!</strong>
                <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
                    {{ user.profile.get_plan_display }}
                </span>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                    Análisis disponibles: <strong>{{ analyses_remaining }}/{{ user.profile.analyses_limit_monthly }}</strong>
                    {% if user.profile.plan != 'free' %}
                        | Renovación en {{ days_until_renewal }} días
                    {% endif %}
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 15px;">
            <a href="/profile/" style="padding: 8px 16px; background: white; border: 1px solid #dee2e6; border-radius: 6px; text-decoration: none; color: #333;">
                Mi Perfil
            </a>
            {% if user.profile.plan == 'free' %}
            <a href="/upgrade/" style="padding: 8px 16px; background: #28a745; color: white; border-radius: 6px; text-decoration: none;">
                🚀 Upgrade a Pro
            </a>
            {% endif %}
            <button onclick="logout()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Cerrar Sesión
            </button>
        </div>
    </div>
</div>
{% else %}
<div style="background: linear-gradient(90deg, #fff3cd 0%, #ffeeba 100%); padding: 15px 0; border-bottom: 2px solid #ffc107;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <span style="font-size: 20px;">🎁</span>
            <div>
                <strong>¡Obtén 5 análisis GRATIS cada mes!</strong>
                <span style="color: #856404; margin-left: 10px;">
                    Te quedan {{ analyses_remaining }} análisis en esta sesión
                </span>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="/register/" style="padding: 10px 20px; background: #28a745; color: white; border-radius: 6px; text-decoration: none; font-weight: 600;">
                Registrarse Gratis
            </a>
            <a href="/login/" style="padding: 10px 20px; background: white; border: 2px solid #667eea; color: #667eea; border-radius: 6px; text-decoration: none; font-weight: 600;">
                Iniciar Sesión
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- MODAL DE LÍMITE ALCANZADO (agregar antes del </body>) -->
<div id="limitModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h2 style="color: #dc3545; margin-bottom: 20px;">⚠️ Límite Alcanzado</h2>
        <div id="limitMessage"></div>
        
        {% if not user.is_authenticated %}
        <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin: 20px 0;">
            <h3 style="color: #155724; margin-bottom: 10px;">🎁 Regístrate GRATIS y obtén:</h3>
            <ul style="color: #155724; padding-left: 20px;">
                <li>5 análisis cada mes</li>
                <li>Historial permanente</li>
                <li>Acceso a plantillas</li>
                <li>Exportación PDF</li>
            </ul>
        </div>
        {% endif %}
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            {% if user.is_authenticated %}
                <a href="/upgrade/" style="flex: 1; padding: 12px; background: #28a745; color: white; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 600;">
                    🚀 Actualizar a Pro ($29/mes)
                </a>
            {% else %}
                <a href="/register/" style="flex: 1; padding: 12px; background: #28a745; color: white; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 600;">
                    Registrarse Gratis
                </a>
                <a href="/login/" style="flex: 1; padding: 12px; background: #667eea; color: white; border-radius: 8px; text-align: center; text-decoration: none; font-weight: 600;">
                    Ya tengo cuenta
                </a>
            {% endif %}
            <button onclick="closeLimitModal()" style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                Cerrar
            </button>
        </div>
    </div>
</div>

    <div class="main-container">
        <!-- Tabs de navegación -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('basic')">
                📝 Análisis Básico
            </button>
            <button class="tab" onclick="showTab('advanced')">
                🎯 Análisis Avanzado
            </button>
            <button class="tab" onclick="showTab('competitor')">
                🔍 Análisis de Competencia
            </button>
            <button class="tab" onclick="showTab('bulk')">
                📊 Análisis en Lote
            </button>
        </div>

        <!-- FORMULARIO BÁSICO -->
        <div class="card" id="basicForm">
            <form id="analysisForm">
                {% csrf_token %}
                
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="product_url">
                            🔗 URL del Producto
                            <span class="tooltip">❓
                                <span class="tooltiptext">
                                    Pega la URL completa del producto de Amazon, Shopify, o cualquier tienda
                                </span>
                            </span>
                        </label>
                        <input type="url" id="product_url" name="product_url" 
                               placeholder="https://www.amazon.com/producto..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="target_audience">
                            👥 Público Objetivo
                            <span class="label-helper">(Sé específico)</span>
                        </label>
                        <textarea id="target_audience" name="target_audience" rows="3"
                                  placeholder="Ej: Mujeres de 25-35 años, profesionales, interesadas en fitness y bienestar, con ingresos medios-altos..."
                                  required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="additional_context">
                            💡 Contexto Adicional
                            <span class="label-helper">(Opcional)</span>
                        </label>
                        <textarea id="additional_context" name="additional_context" rows="3"
                                  placeholder="Ej: Época del año, eventos especiales, tendencias actuales..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="platform">📱 Plataforma Principal</label>
                        <select id="platform" name="platform" required>
                            <option value="">Selecciona...</option>
                            <option value="instagram">Instagram</option>
                            <option value="tiktok">TikTok</option>
                            <option value="facebook">Facebook</option>
                            <option value="youtube">YouTube</option>
                            <option value="blog">Blog/SEO</option>
                            <option value="email">Email Marketing</option>
                            <option value="twitter">Twitter/X</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="budget">💰 Presupuesto Estimado</label>
                        <select id="budget" name="budget">
                            <option value="low">Bajo ($0-100)</option>
                            <option value="medium">Medio ($100-500)</option>
                            <option value="high">Alto ($500+)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="campaign_goal">🎯 Objetivo de Campaña</label>
                        <select id="campaign_goal" name="campaign_goal">
                            <option value="awareness">Conocimiento de marca</option>
                            <option value="traffic">Generar tráfico</option>
                            <option value="conversions">Maximizar conversiones</option>
                            <option value="engagement">Aumentar engagement</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tone">🎨 Tono de Comunicación</label>
                        <select id="tone" name="tone">
                            <option value="professional">Profesional</option>
                            <option value="casual">Casual/Amigable</option>
                            <option value="humorous">Humorístico</option>
                            <option value="inspirational">Inspiracional</option>
                            <option value="urgent">Urgente/Directo</option>
                        </select>
                    </div>
                </div>

                <!-- Opciones avanzadas -->
                <button type="button" class="toggle-advanced" onclick="toggleAdvanced()">
                    ⚙️ Mostrar Opciones Avanzadas
                </button>
                
                <div class="advanced-options" id="advancedOptions" style="display: none;">
                    <h3>🔧 Configuración Avanzada</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="competitors">🏆 URLs de Competidores</label>
                            <textarea id="competitors" name="competitors" rows="2"
                                      placeholder="Una URL por línea"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="keywords">🔑 Keywords Objetivo</label>
                            <input type="text" id="keywords" name="keywords"
                                   placeholder="Separadas por comas">
                        </div>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="api_key">
                        🔑 API Key de IA
                        <span class="label-helper">(Gemini o Cohere)</span>
                    </label>
                    <input type="password" id="api_key" name="api_key" 
                           placeholder="Tu clave API" required>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        🚀 Generar Estrategia Completa
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="useTemplate()">
                        📋 Usar Plantilla
                    </button>
                </div>
            </form>

            <!-- Sección de Plantillas -->
            {% if templates %}
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">🎨 Plantillas Exitosas</h3>
                <p style="color: #666; margin-bottom: 15px;">Selecciona una plantilla probada para mejores resultados:</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    {% for template in templates %}
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e1e1e1; 
                                cursor: pointer; transition: all 0.3s;"
                        onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'"
                        onmouseout="this.style.borderColor='#e1e1e1'; this.style.transform='translateY(0)'"
                        onclick="selectTemplate('{{ template.platform }}', '{{ template.name }}')">
                        <h4 style="margin: 0 0 8px 0; color: #333;">{{ template.name }}</h4>
                        <p style="margin: 0 0 5px 0; font-size: 14px; color: #666;">
                            📱 {{ template.get_platform_display }}
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #667eea; font-weight: bold;">
                            ⭐ {{ template.success_rate }}% de éxito
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #888;">
                            {{ template.category|capfirst }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- FORMULARIO DE COMPETENCIA -->
        <div class="card" id="competitorForm" style="display: none;">
            <h2>🥊 Análisis Competitivo Inteligente</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Descubre qué están haciendo tus competidores y cómo superarlos
            </p>

            <form id="competitorAnalysisForm">
                {% csrf_token %}
                <input type="hidden" name="analysis_type" value="competitor">
                
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="main_product_url">
                            🎯 Tu Producto Principal
                        </label>
                        <input type="url" id="main_product_url" name="main_product_url" 
                               placeholder="URL del producto que quieres promocionar" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>🥊 Competidores Directos</label>
                        <div id="competitorsList">
                            <input type="url" name="competitor_1" 
                                   placeholder="URL Competidor 1 - Producto similar" required 
                                   style="margin-bottom: 10px;">
                            <input type="url" name="competitor_2" 
                                   placeholder="URL Competidor 2 - Producto similar" required
                                   style="margin-bottom: 10px;">
                            <input type="url" name="competitor_3" 
                                   placeholder="URL Competidor 3 (opcional)"
                                   style="margin-bottom: 10px;">
                        </div>
                        <button type="button" onclick="addCompetitorField()" 
                                style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                            ➕ Agregar más competidores
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="comp_target_audience">👥 Público Objetivo</label>
                        <textarea id="comp_target_audience" name="target_audience" rows="3"
                                  placeholder="Ej: Emprendedores digitales de 28-45 años con ingresos $50K+" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="comp_platform">📱 Plataforma de Competencia</label>
                        <select id="comp_platform" name="platform" required>
                            <option value="">¿En qué plataforma compites?</option>
                            <option value="instagram">📷 Instagram</option>
                            <option value="tiktok">🎵 TikTok</option>
                            <option value="youtube">📺 YouTube</option>
                            <option value="facebook">👥 Facebook</option>
                            <option value="email">📧 Email Marketing</option>
                            <option value="general">🌐 Todas las plataformas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="analysis_focus">🎯 Enfoque del Análisis</label>
                        <select id="analysis_focus" name="analysis_focus">
                            <option value="complete">🚀 Análisis Completo</option>
                            <option value="pricing">💰 Estrategia de Precios</option>
                            <option value="content">📝 Estrategia de Contenido</option>
                            <option value="positioning">🎯 Posicionamiento</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="comp_api_key">🔑 API Key de IA</label>
                        <input type="password" id="comp_api_key" name="api_key" 
                               placeholder="Tu clave API de Gemini" required>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        🥊 Analizar Competencia
                    </button>
                </div>
            </form>

            <!-- Preview de beneficios -->
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); 
                        color: white; border-radius: 10px;">
                <h4>🎯 Con este análisis obtendrás:</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>💰 Comparación detallada de precios y posicionamiento</li>
                    <li>🕳️ Gaps de mercado que puedes explotar inmediatamente</li>
                    <li>⚔️ Estrategias específicas para superar a cada competidor</li>
                    <li>🚀 5 tácticas inmediatas para robar market share</li>
                    <li>📊 Análisis visual de tu posición competitiva</li>
                </ul>
            </div>
        </div>

        <!-- CONTENEDOR DE TODOS LOS RESULTADOS -->
        <div class="all-results-container">
            <!-- Tabs para cambiar entre resultados (solo se muestra si hay múltiples) -->
            <div class="results-tabs" id="resultsTabs">
                <button class="results-tab" id="tabBasic" onclick="showResultTab('basic')">
                    📊 Análisis Básico
                </button>
                <button class="results-tab" id="tabCompetitive" onclick="showResultTab('competitive')">
                    🥊 Análisis Competitivo
                </button>
            </div>

            <!-- Resultados para Análisis Básico -->
            <div id="basicResultsSection" style="display: none;" class="results-section">
                <div class="results-grid">
                    <div class="strategy-card">
                        <span class="analysis-type-badge badge-basic">📊 Análisis Básico</span>
                        <h2>Estrategia Generada</h2>
                        <div id="basicStrategyContent"></div>
                        
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="downloadStrategy('basic')">
                                📥 Descargar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="saveAsTemplate()">
                                💾 Guardar como Plantilla
                            </button>
                            <button class="btn btn-primary" onclick="rateStrategy()">
                                ⭐ Calificar Estrategia
                            </button>
                        </div>
                    </div>
                    
                    <div class="metrics-card">
                        <h3>📈 Métricas Clave</h3>
                        <div class="metric">
                            <span>Engagement Estimado</span>
                            <span class="metric-value" id="basicEngagementRate">--</span>
                        </div>
                        <div class="metric">
                            <span>Dificultad SEO</span>
                            <span class="metric-value" id="basicSeoDifficulty">--</span>
                        </div>
                        <div class="metric">
                            <span>Potencial de Conversión</span>
                            <span class="metric-value" id="basicConversionPotential">--</span>
                        </div>
                        
                        <h4 style="margin-top: 20px;">🏷️ Tags Sugeridos</h4>
                        <div class="strategy-tags" id="basicSuggestedTags"></div>
                    </div>
                </div>
            </div>

            <!-- Resultados para Análisis Competitivo -->
            <div id="competitiveResultsSection" style="display: none;" class="results-section">
                <div class="results-grid">
                    <div class="strategy-card">
                        <span class="analysis-type-badge badge-competitive">🥊 Análisis Competitivo</span>
                        <h2>Estrategia Competitiva Generada</h2>
                        <div id="competitiveStrategyContent"></div>
                        
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="downloadStrategy('competitive')">
                                📥 Descargar PDF Competitivo
                            </button>
                            <button class="btn btn-secondary" onclick="saveAsTemplate()">
                                💾 Guardar como Plantilla
                            </button>
                            <button class="btn btn-primary" onclick="rateStrategy()">
                                ⭐ Calificar Estrategia
                            </button>
                        </div>
                    </div>
                    
                    <div class="metrics-card">
                        <h3>🎯 Métricas Competitivas</h3>
                        <div class="metric">
                            <span>Engagement Estimado</span>
                            <span class="metric-value" id="competitiveEngagementRate">--</span>
                        </div>
                        <div class="metric">
                            <span>Dificultad SEO</span>
                            <span class="metric-value" id="competitiveSeoDifficulty">--</span>
                        </div>
                        <div class="metric">
                            <span>Potencial de Conversión</span>
                            <span class="metric-value" id="competitiveConversionPotential">--</span>
                        </div>
                        
                        <h4 style="margin-top: 20px;">🏷️ Tags Competitivos</h4>
                        <div class="strategy-tags" id="competitiveSuggestedTags"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">
            <div class="spinner"></div>
            <h3>Analizando producto...</h3>
            <p id="loadingStatus">Extrayendo información del producto...</p>
        </div>
    </div>

    <script>
    // Variables globales
    let currentAnalysisId = null;
    let competitorFieldCount = 3;
    let currentAnalysisType = 'basic';
    
    // Objeto para almacenar todos los resultados
    let analysisResults = {
        basic: null,
        competitive: null
    };

    // Función para seleccionar plantilla
    function selectTemplate(platform, templateName) {
        document.getElementById('platform').value = platform;
        
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = `✅ Plantilla "${templateName}" seleccionada`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Función para mostrar tabs
    function showTab(tabName) {
        document.getElementById('basicForm').style.display = 'none';
        document.getElementById('competitorForm').style.display = 'none';
        
        if (tabName === 'basic') {
            document.getElementById('basicForm').style.display = 'block';
        } else if (tabName === 'competitor') {
            document.getElementById('competitorForm').style.display = 'block';
        }
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
    }

    // Función para mostrar tabs de resultados
    function showResultTab(type) {
        // Ocultar todas las secciones de resultados
        document.querySelectorAll('.results-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Mostrar la sección seleccionada
        if (type === 'basic' && analysisResults.basic) {
            document.getElementById('basicResultsSection').style.display = 'block';
        } else if (type === 'competitive' && analysisResults.competitive) {
            document.getElementById('competitiveResultsSection').style.display = 'block';
        }
        
        // Actualizar tabs activos
        document.querySelectorAll('.results-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById('tab' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
    }

    // Función para actualizar visibilidad de tabs
    function updateResultsTabs() {
        const hasBasic = analysisResults.basic !== null;
        const hasCompetitive = analysisResults.competitive !== null;
        const hasBoth = hasBasic && hasCompetitive;
        
        const tabsContainer = document.getElementById('resultsTabs');
        
        if (hasBoth) {
            // Mostrar tabs si hay ambos resultados
            tabsContainer.style.display = 'flex';
            
            // Actualizar visibilidad de tabs individuales
            document.getElementById('tabBasic').style.display = hasBasic ? 'block' : 'none';
            document.getElementById('tabCompetitive').style.display = hasCompetitive ? 'block' : 'none';
        } else {
            // Ocultar tabs si solo hay un resultado
            tabsContainer.style.display = 'none';
        }
    }

    function toggleAdvanced() {
        const advanced = document.getElementById('advancedOptions');
        advanced.style.display = advanced.style.display === 'none' ? 'block' : 'none';
        event.target.textContent = advanced.style.display === 'none' 
            ? '⚙️ Mostrar Opciones Avanzadas' 
            : '⚙️ Ocultar Opciones Avanzadas';
    }

    function addCompetitorField() {
        if (competitorFieldCount >= 5) {
            alert('Máximo 5 competidores permitidos');
            return;
        }
        
        competitorFieldCount++;
        const competitorsList = document.getElementById('competitorsList');
        const newInput = document.createElement('input');
        newInput.type = 'url';
        newInput.name = `competitor_${competitorFieldCount}`;
        newInput.placeholder = `URL Competidor ${competitorFieldCount} (opcional)`;
        newInput.style.marginBottom = '10px';
        
        competitorsList.appendChild(newInput);
    }

    // Manejo del formulario básico
    document.getElementById('analysisForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const overlay = document.getElementById('loadingOverlay');
        const status = document.getElementById('loadingStatus');
        
        overlay.style.display = 'flex';
        
        const steps = [
            'Extrayendo información del producto...',
            'Analizando competencia...',
            'Generando estrategias personalizadas...',
            'Calculando métricas de rendimiento...',
            'Finalizando análisis...'
        ];
        
        let stepIndex = 0;
        const stepInterval = setInterval(() => {
            if (stepIndex < steps.length) {
                status.textContent = steps[stepIndex];
                stepIndex++;
            }
        }, 1000);
        
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            clearInterval(stepInterval);
            
            if (data.success) {
                currentAnalysisId = data.analysis_id;
                displayResults(data);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            clearInterval(stepInterval);
            alert('Error de conexión');
        } finally {
            overlay.style.display = 'none';
        }
    });

    // Manejo del formulario de competencia
    document.getElementById('competitorAnalysisForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const overlay = document.getElementById('loadingOverlay');
        const status = document.getElementById('loadingStatus');
        
        overlay.style.display = 'flex';
        status.textContent = 'Analizando productos y competidores...';
        
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentAnalysisId = data.analysis_id;
                displayCompetitiveResults(data);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
        } finally {
            overlay.style.display = 'none';
        }
    });

    function displayResults(data) {
        // Guardar resultados básicos
        analysisResults.basic = data;
        
        // Mostrar estrategia BÁSICA
        document.getElementById('basicStrategyContent').innerHTML = formatStrategy(data.response);
        
        // Mostrar métricas BÁSICAS
        document.getElementById('basicEngagementRate').textContent = 
            Math.floor(Math.random() * 30 + 70) + '%';
        document.getElementById('basicSeoDifficulty').textContent = 
            ['Baja', 'Media', 'Alta'][Math.floor(Math.random() * 3)];
        document.getElementById('basicConversionPotential').textContent = 
            Math.floor(Math.random() * 20 + 80) + '%';
        
        // Generar tags BÁSICOS
        const tags = generateTags(data.response);
        document.getElementById('basicSuggestedTags').innerHTML = tags.map(tag => 
            `<span class="tag">#${tag}</span>`
        ).join('');
        
        // Mostrar la sección básica con animación
        const basicSection = document.getElementById('basicResultsSection');
        basicSection.style.display = 'block';
        basicSection.classList.add('new-result');
        
        // Actualizar tabs de resultados
        updateResultsTabs();
        
        // Si hay resultados competitivos, mostrar tabs y activar el básico
        if (analysisResults.competitive) {
            showResultTab('basic');
        }
        
        currentAnalysisType = 'basic';
        basicSection.scrollIntoView({ behavior: 'smooth' });
    }

    function displayCompetitiveResults(data) {
        // Guardar resultados competitivos
        analysisResults.competitive = data;
        
        let formattedStrategy = formatStrategy(data.response);
        
        let content = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 24px;">🏆 Análisis Competitivo Completado</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                        <strong>Producto Principal:</strong><br>
                        ${data.main_product?.title ? data.main_product.title.substring(0, 50) + '...' : 'Tu producto'}
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                        <strong>Competidores Analizados:</strong><br>
                        ${data.competitors_analyzed || 'Múltiples'} productos rivales
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                        <strong>Tipo de Análisis:</strong><br>
                        Competencia Completa
                    </div>
                </div>
            </div>
        `;
        
        if (data.pricing_analysis) {
            const positionText = {
                'premium': '🔥 PREMIUM - Producto de alta gama',
                'competitive': '⚖️ COMPETITIVO - En rango del mercado', 
                'cheapest': '💰 ECONÓMICO - Precio más bajo',
                'unknown': '❓ POSICIÓN INDETERMINADA'
            };
            
            const positionColor = {
                'premium': '#28a745',
                'competitive': '#ffc107',
                'cheapest': '#17a2b8', 
                'unknown': '#6c757d'
            };
            
            const position = data.pricing_analysis.position || 'unknown';
            
            content += `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; 
                            padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin: 0 0 15px 0;">💰 Análisis de Precios Competitivos</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${positionColor[position]};">
                            <strong>Tu Posición en el Mercado:</strong><br>
                            <span style="color: ${positionColor[position]}; font-weight: bold;">
                                ${positionText[position]}
                            </span>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <strong>Recomendación Estratégica:</strong><br>
                            ${data.pricing_analysis.recommendation || 'Mantener estrategia actual'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        content += `
            <div style="background: white; border-radius: 12px; padding: 25px; 
                        box-shadow: 0 4px 15px rgba(0,0,0,0.1); line-height: 1.7;">
                ${formattedStrategy}
            </div>
        `;
        
        document.getElementById('competitiveStrategyContent').innerHTML = content;
        
        // Métricas específicas competitivas
        document.getElementById('competitiveEngagementRate').textContent = 
            Math.floor(Math.random() * 25 + 75) + '%';
        document.getElementById('competitiveSeoDifficulty').textContent = 
            ['Media', 'Alta'][Math.floor(Math.random() * 2)];
        document.getElementById('competitiveConversionPotential').textContent = 
            Math.floor(Math.random() * 15 + 85) + '%';
        
        const competitiveTags = [
            'analisis-competitivo', 'estrategia-diferencial', 'market-share', 
            'posicionamiento', 'ventaja-competitiva', 'gaps-mercado'
        ];
        document.getElementById('competitiveSuggestedTags').innerHTML = competitiveTags.slice(0, 6).map(tag => 
            `<span class="tag">#${tag}</span>`
        ).join('');
        
        // Mostrar la sección competitiva con animación
        const competitiveSection = document.getElementById('competitiveResultsSection');
        competitiveSection.style.display = 'block';
        competitiveSection.classList.add('new-result');
        
        // Actualizar tabs de resultados
        updateResultsTabs();
        
        // Si hay resultados básicos, mostrar tabs y activar el competitivo
        if (analysisResults.basic) {
            showResultTab('competitive');
        }
        
        currentAnalysisType = 'competitive';
        competitiveSection.scrollIntoView({ behavior: 'smooth' });
    }

    function formatStrategy(text) {
        return text
            .replace(/^# (.*)/gm, '<h2 style="color: #667eea; margin: 30px 0 15px 0; padding-bottom: 10px; border-bottom: 3px solid #667eea; font-size: 24px;">$1</h2>')
            .replace(/^## (.*)/gm, '<h3 style="color: #495057; margin: 25px 0 12px 0; font-size: 20px;">$1</h3>')
            .replace(/^### (.*)/gm, '<h4 style="color: #6c757d; margin: 20px 0 10px 0; font-size: 18px;">$1</h4>')
            .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>')
            .replace(/^- (.*)/gm, '<li style="margin-bottom: 8px; padding-left: 5px;">$1</li>')
            .replace(/\n\n/g, '</p><p style="margin-bottom: 15px; text-align: justify;">')
            .replace(/(<li.*<\/li>\s*)+/g, '<ul style="margin: 15px 0; padding: 15px 15px 15px 40px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">$&</ul>')
            .replace(/^/, '<p style="margin-bottom: 15px; text-align: justify;">')
            .replace(/$/, '</p>');
    }


    function generateTags(text) {
        const hashtags = text.match(/#\w+/g) || [];
        const defaultTags = ['marketing', 'afiliados', 'ventas', 'estrategia'];
        return [...new Set([...hashtags.map(h => h.slice(1)), ...defaultTags])].slice(0, 8);
    }

    function downloadStrategy(analysisType) {
        if (currentAnalysisId) {
            window.open(`/download-pdf/${currentAnalysisId}/?type=${analysisType || currentAnalysisType}`, '_blank');
        } else {
            alert('No hay estrategia para descargar');
        }
    }

    function saveAsTemplate() {
        alert('Función de guardar plantilla en desarrollo');
    }

    function rateStrategy() {
        const rating = prompt('Califica esta estrategia del 1 al 5:');
        if (rating) {
            alert('¡Gracias por tu calificación!');
        }
    }

    function useTemplate() {
        const templates = document.querySelector('[style*="Plantillas Exitosas"]');
        if (templates) {
            templates.scrollIntoView({ behavior: 'smooth' });
        }
    }

    </script>
</body>
</html>